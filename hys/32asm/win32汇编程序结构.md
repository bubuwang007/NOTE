# 1 模式定义

~~~assembly
.386
.model flat,stdcall
option casemap:none
~~~

.386是指汇编语言的伪指令，在低版本的时候宏汇编中已经存在，类似的指令还有.8086， .186， .286，.386/.386p，.486/.486p 和 .586/.586p等，用于告诉编译器在本程序中的指令集。Win32环境工作在80386及以上的处理器中，所以.386必不可少。后面p的伪指令表示程序中可以使用特权指令。

~~~assembly
.model 内存模式[,语言模式][,其他模式]
~~~

内存模式

|  模式   |                        内存使用方式                        |
| :-----: | :--------------------------------------------------------: |
|  tiny   | 用来建立.com文件，所有的代码、数据和堆栈都在同一个64KB段内 |
|  small  |          建立代码和数据分别用一个64KB段的.exe文件          |
| medium  |        代码段可以有多个64KB段，数据段只有一个64KB段        |
| compact |        代码段只有一个64KB段，数据段可以有多个64KB段        |
|  large  |              代码段和数据段都可以有多个64KB段              |
|  huge   |        同large,并且数据段中的一个数组也可以超过64KB        |
|  flat   |      Win32程序使用的模式，代码和数据段使用同一个4GB段      |

如果定义了.model flat，MASM自动为各种段寄存器做了如下定义：

~~~assembly
ASSUME cs:FLAT, ds:FLAT, ss:FLAT, es:FLAT fs:ERROR, gs:ERROR
~~~

也就是说，CS,DS,ES和SS段全部使用平坦模式，FS和GS寄存器默认不使用，这时若在源程序中使用FS或GS,在编译时会报错。

在Win32汇编中，.model语句中还应该指定语言模式，即子程序的调用方式，例子中用的是stdcall,它指出了调用子程序或Win32API时参数传递的次序和堆栈平衡的方法。

用option语句定义的选项有很多，如option language定义和option segment定义等，在Win32汇编程序中，需要的只是定义option casemap:none,这个语句定义了程序中的变量和子程序名是否对大小写敏感，由于Win32API中的API名称是区分大小写的，所以必须指定这个选项，否则在调用API的时候会有问题。



# 2 段的定义